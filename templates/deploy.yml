name: Deploy with no-wing

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials for Developer
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.DEV_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}
        role-session-name: GitHubActions-Deploy
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm test
    
    - name: Build application
      run: npm run build
    
    - name: Deploy to AWS
      run: npm run deploy
      
    # Q participates in the deployment process
    - name: Q Analysis and Monitoring
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.Q_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}
        role-session-name: Q-Analysis
    
    - name: Q Post-Deployment Check
      run: |
        echo "ü§ñ Q: Analyzing deployment results..."
        
        # Q can check CloudWatch logs
        aws logs describe-log-groups --log-group-name-prefix "/aws/lambda" --query 'logGroups[0].logGroupName' --output text
        
        # Q can verify stack status
        aws cloudformation describe-stacks --query 'Stacks[0].StackStatus' --output text
        
        echo "ü§ñ Q: Deployment analysis complete!"
        echo "ü§ñ Q: All systems operational. Ready for next iteration!"
        
        # Q logs its own activity
        echo "ü§ñ Q: Logging capability usage for progression tracking..."
    
    - name: Notify on Success
      if: success()
      run: |
        echo "‚úÖ Deployment successful!"
        echo "ü§ñ Q: Great teamwork! Both human and AI contributions deployed successfully."
    
    - name: Notify on Failure  
      if: failure()
      run: |
        echo "‚ùå Deployment failed!"
        echo "ü§ñ Q: Don't worry, I'm analyzing the logs to help debug this issue."
